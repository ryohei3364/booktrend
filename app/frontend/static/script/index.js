import { initNavbar } from './navbar.js';
await initNavbar();  // Á≠âÂæÖ navbar ÂÆåÊàêÂæåÂÜçÁπºÁ∫åÂü∑Ë°å

import { loadLang, switchLang } from './language.js';
switchLang();  // Á∂ÅÂÆöË™ûË®ÄÈÅ∏ÂñÆ

async function initPage() {
  // await getUserCookie();
  const { countryList } = await loadLang();
  // renderNav(langContent);
  renderCard(countryList);
}

let sectionRenderQueue = [];
const cardContainer = document.querySelector(".main__card--container");

async function renderCard(data) {
  const filteredList = data.filter(data => data.id !== 3);

  const fragment = document.createDocumentFragment();
  filteredList.forEach(country => {
    const card = createCountryCard(country);
    fragment.appendChild(card);
  });
  cardContainer.appendChild(fragment);

  // ‚¨áÔ∏è Ê†πÊìö section È°ûÂûãÊâπÊ¨°Ê∏≤ÊüìÂÖßÂÆπ
  const renderOrder = ["category", "samebook", "author", "yearly", "daily", "wordcloud"];
  for (const sectionType of renderOrder) {
    const sectionsToRender = sectionRenderQueue.filter(s => s.className === sectionType);
    for (const { bookstoreId, contentContainer } of sectionsToRender) {
      switch (sectionType) {
        case "category":
          const canvas1 = document.createElement("canvas");
          canvas1.width = 300;
          canvas1.height = 450;
          contentContainer.appendChild(canvas1);
          await createCategory(bookstoreId, canvas1);
          break;
        case "samebook":
          await createSameBooks(bookstoreId, contentContainer);
          break;
        case "author":
          const canvas2 = document.createElement("canvas");
          contentContainer.appendChild(canvas2);
          await createAuthor(bookstoreId, canvas2);
          break;
        case "yearly":
          await createRanking(bookstoreId, contentContainer, fetchYearlyData);
          // await createYearly(bookstoreId, contentContainer);
          break;
        case "daily":
          await createRanking(bookstoreId, contentContainer, fetchDailyData);
          // await createDaily(bookstoreId, contentContainer);
          break;
        case "wordcloud":
          await createWordCloud(bookstoreId, contentContainer);
          break;
      }
    }
  }
}


function createCountryCard(data) {
  const card = document.createElement("div");
  card.className = "main__card";
  card.dataset.country = data.code;

	const title = document.createElement("div");
  title.className = "main__card--title";

	const span = document.createElement('span');
  span.className = "main__card--country";
	span.textContent = data.country;

	const logo = document.createElement('img');
	logo.className = 'logo';
	logo.src = data.logo;

	const map = document.createElement('img');
	map.className = 'map';
	map.src = data.map;

	title.appendChild(logo);
	title.appendChild(map);
  card.appendChild(span);
	card.appendChild(title);

  // ÁÇ∫ÊØèÂÄã section Âª∫Á´ãÂÆπÂô®‰ΩÜ‰∏çÊ∏≤ÊüìÂÖßÂÆπ
  data.sections.forEach(section => {
    const sectionDiv = document.createElement("div");
    sectionDiv.className = `main__card--section ${section.class}`;

    // ‰∏äÊñπÊ®ôÈ°å + icon
    const header = document.createElement("div");
    header.className = "section-header";

    const icon = createSvgIcon("more");
    const titleSpan = document.createElement("span");
    titleSpan.textContent = section.title;

    header.appendChild(icon);
    header.appendChild(titleSpan);

    // ‰∏ãÊñπÂÖßÂÆπÂçÄÂ°äÔºàÈóúÈçµÂ≠óÈõ≤Ôºâ
    const content = document.createElement("div");
    content.className = "section-content";

    // üëâ Êé®ÂÖ•ÂæÖÊ∏≤Êüì‰ΩáÂàó
    sectionRenderQueue.push({
      className: section.class,
      bookstoreId: data.bookstore_id,
      contentContainer: content
    });
    // Âä†ÂÖ•ÂçÄÂ°äÂà∞‰∏ªÂç°Áâá
    sectionDiv.appendChild(header);
    sectionDiv.appendChild(content);
    // Â∞ç sectionDiv + header + content Â•óÁî® toggle ÂäüËÉΩ
    setupToggle(sectionDiv, header, content);
    card.appendChild(sectionDiv);
  });
  return card;
}

// async function sendUserLanguage() {
//   const userLanguages = navigator.languages.join(',');
//   const response = await fetch('/api/language', {
//     headers: {
//       "Accept-Language": userLanguages
//     }
//   });
//   const data = await response.json();
//   console.log("ÂæåÁ´ØÊî∂Âà∞ÁöÑË™ûË®ÄÂÅèÂ•Ω:", data);
// }

// async function fetchCardData() {
//   const response = await fetch("/api/language");
//   return response.json();
// }

async function fetchCategoryData(bookstoreId) {
  const response = await fetch(`/api/card/category/${bookstoreId}`);
  return response.json();
}

async function fetchSameBooksData(bookstoreId) {
  const response = await fetch(`/api/card/samebook/${bookstoreId}`);
  return response.json();
}

async function fetchAuthorData(bookstoreId) {
  const response = await fetch(`/api/card/author/${bookstoreId}`);
  return response.json();
}

async function fetchYearlyData(bookstoreId) {
  const response = await fetch(`/api/card/yearly/${bookstoreId}`);
  return response.json();
}

async function fetchDailyData(bookstoreId) {
  const response = await fetch(`/api/card/daily/${bookstoreId}`);
  return response.json();
}

async function fetchWordCloudData(bookstoreId) {
  const response = await fetch(`/api/card/wordcloud/${bookstoreId}`);
  return response.json();
}

async function createCategory(bookstoreId, canvas) {
  const chartData = await fetchCategoryData(bookstoreId);
  createChart(canvas, chartData);
}

async function createSameBooks(bookstoreId, container) {
  const sameBooks = await fetchSameBooksData(bookstoreId);

  sameBooks.forEach(book => {
    const bookCard = document.createElement("div");
    bookCard.className = "book-card";

    const author = document.createElement("h4");
    author.textContent = book.name;

    const img = document.createElement("img");
    img.src = book.image_url;
    img.alt = book.title;

    const title = document.createElement("p");
    title.textContent = book.title;

    // Âä†ÂÖ•ÊâÄÊúâÂÖÉÁ¥†
    bookCard.appendChild(author);
    bookCard.appendChild(img);
    bookCard.appendChild(title);

    container.appendChild(bookCard);
  });
}


async function createAuthor(bookstoreId, canvas) {
  const authors = await fetchAuthorData(bookstoreId);

  const labels = authors.map(a => a.author_name);
  const data = authors.map(a => a.times);

  const chartData = {
    labels: labels,
    datasets: [{
      label: 'Êö¢Èä∑Êõ∏Êú¨Êï∏',
      data: data,
      backgroundColor: ['#f94144', '#f3722c', '#f8961e'],
      borderWidth: 1
    }]
  };
  createChart(canvas, chartData, "bar");
}

async function createRanking(bookstoreId, container, fetchFn) {
  const books = await fetchFn(bookstoreId);
  books.forEach(book => {
    const bookCard = document.createElement("div");
    bookCard.className = "book-card";

    const rank = document.createElement("div");
    rank.className = "book-rank";
    rank.textContent = `No. ${book.ranking}`;

    const author = document.createElement("h4");
    author.textContent = book.author_name;

    const img = document.createElement("img");
    img.src = book.image_url;
    img.alt = book.title;

    const title = document.createElement("p");
    title.textContent = book.title;

    bookCard.appendChild(rank);
    bookCard.appendChild(author);
    bookCard.appendChild(img);
    bookCard.appendChild(title);
    container.appendChild(bookCard);
  });
}

async function createWordCloud(bookstoreId, container) {
  const cloudData = await fetchWordCloudData(bookstoreId);

  // 1Ô∏è‚É£ ÂÖà‰æùÁÖßÈ†ªÁéáÊéíÂ∫èÔºàÈ´òÂà∞‰ΩéÔºâ
  cloudData.sort((a, b) => b.size - a.size);

  // 2Ô∏è‚É£ Ë®àÁÆóÊúÄÂ§ßËàáÊúÄÂ∞èÈ†ªÁéáÔºåÂª∫Á´ãÂ≠óÈ´îÁ∏ÆÊîæÊØî‰æãÂ∞∫
  const maxFreq = cloudData[0].size;
  const minFreq = cloudData[cloudData.length - 1].size;

  const fontSizeScale = d3.scaleLinear()
    .domain([minFreq, maxFreq])
    .range([36, 80]); // ÊúÄÂ∞èÂ≠óÈ´îÂà∞ÊúÄÂ§ßÂ≠óÈ´îÂ§ßÂ∞èÔºåÂèØËá™Ë°åË™øÊï¥
  
  const width = 500;
  const height = 350;
  const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

  d3.layout.cloud()
    .size([width, height])
    .words(cloudData.map(d => ({
      text: d.text,
      size: fontSizeScale(d.size),
    })))
    .padding(5)
    // .rotate(() => (Math.random() > 0.5 ? 0 : 90)) 
    .rotate(d => {
      // üëâ Â§ßÂ≠ó‰∏çÊóãËΩâÔºåÂ∞èÂ≠óÊâçÈö®Ê©üÊóãËΩâ
      if (d.size > 40) return 0;
      return Math.random() > 0.5 ? 90 : -90;
    })
    .font("Impact")
    .fontSize(d => {
      const isChinese = /[\u4e00-\u9fff]/.test(d.text);
      return isChinese ? d.size * 1 : d.size;
    })
    .on("end", (words) => {
      d3.select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`)
        .selectAll("text")
        .data(words)
        .enter()
        .append("text")
        .style("font-family", "Impact")
        .style("font-size", d => `${d.size}px`)
        .style("fill", (d, i) => colorScale(i))
        .attr("text-anchor", "middle")
        .attr("transform", d => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
        .text(d => d.text);
    })
    .start();
}

function createSvgIcon(type) {
	const svgNS = "http://www.w3.org/2000/svg";
	const svgMap = document.createElementNS(svgNS, "svg");
	svgMap.classList.add("icon");
	svgMap.setAttribute("xmlns", svgNS);
	svgMap.setAttribute("fill", "none");
	svgMap.setAttribute("viewBox", "0 0 24 24");
	svgMap.setAttribute("width", "36");
	svgMap.setAttribute("height", "36");
	svgMap.setAttribute("stroke-width", "1.5");
	svgMap.style.stroke = "var(--mintgreen-color)";
	svgMap.style.backgroundColor = "transparent";
	svgMap.style.flexShrink = "0"; // Èò≤Ê≠¢Á∏ÆÂ∞è

	const path = document.createElementNS(svgNS, "path");
	path.setAttribute("stroke-linecap", "round");
	path.setAttribute("stroke-linejoin", "round");
	path.setAttribute("fill", "none");

	if (type === "more") {
		path.setAttribute("d", "M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z");
	} else {
		path.setAttribute("d", "M15 12H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z");
	}
	svgMap.appendChild(path);
	return svgMap;
}



function setupToggle(sectionDiv, header, content) {
  // È†êË®≠ÁÇ∫Â±ïÈñã
  let isOpen = true;
  content.classList.remove("collapsed");
  header.querySelector("svg")?.replaceWith(createSvgIcon("less"));

  // let isOpen = false;

  // sectionDiv.addEventListener("mouseenter", () => {
  //   isOpen = true;
  //   content.classList.remove("collapsed");
  //   header.querySelector("svg")?.replaceWith(createSvgIcon("less"));
  // });

  // sectionDiv.addEventListener("mouseleave", () => {
  //   isOpen = false;
  //   content.classList.add("collapsed");
  //   header.querySelector("svg")?.replaceWith(createSvgIcon("more"));
  // });
  sectionDiv.addEventListener("click", () => {
    isOpen = !isOpen;

    if (isOpen) {
      content.classList.remove("collapsed");
      header.querySelector("svg")?.replaceWith(createSvgIcon("less"));
    } else {
      content.classList.add("collapsed");
      header.querySelector("svg")?.replaceWith(createSvgIcon("more"));
    }
  });
}

function createChart(canvas, chartData, defaultType = "doughnut") {
  // tooltip ÊúÉÂõ†ÁÇ∫Ê≤íÊúâÈáçÁï´Ë¢´Êìã‰ΩèÔºåÂä†‰∫ÜÂ∞±OK‰∫Ü
  // ‚úÖ Á¢∫‰øùÂêå‰∏ÄÂÄã canvas ‰∏çÊúÉË¢´Áï´Á¨¨‰∫åÊ¨°
  const existingChart = Chart.getChart(canvas);
  if (existingChart) {
    existingChart.destroy(); // Ê∏ÖÈô§Ââç‰∏ÄÂÄãÂúñË°®
  }
  const ctx = canvas.getContext("2d");

  // Âæû chartData ÂèñÂá∫ÁøªË≠ØÂ∞çÊáâË°®ÔºàÂ¶ÇÊûúÊúâÔºâ
  const translations = chartData.translations || {};
  console.log(translations);

  // Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÂÆåÊï¥ÁöÑ Chart.js Ë®≠ÂÆöÔºàÂê´ type Âíå optionsÔºâ
  const config = chartData.type
    ? chartData // Â∑≤ÊòØÂÆåÊï¥ÁöÑ configÔºåÁõ¥Êé•‰ΩøÁî®
    : {
        type: defaultType, // È†êË®≠È°ûÂûã
        data: chartData,
        options: {
          responsive: false, // ‚úÖ ÂÅúÁî®Ëá™ÂãïÁ∏ÆÊîæ
          maintainAspectRatio: false, // ‚úÖ ÂÖÅË®±ÊâãÂãïÊéßÂà∂ÊØî‰æã
          // cutout: "80%", // ‚úÖ ÊéßÂà∂ÂúìÂøÉÁ©∫ÁôΩÊØî‰æã
          // radius: "100%", // ‚úÖ ÊéßÂà∂ÂúìÈ§ÖÊï¥È´îÂ§ßÂ∞èÔºàÂèØË™øÊï¥Ôºâ
          plugins: {
            legend: {
              position: "bottom"
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function (tooltipItem) {
                  const dataIndex = tooltipItem.dataIndex;
                  const datasetIndex = tooltipItem.datasetIndex;

                  const originalLabel = chartData.labels[dataIndex];
                  const translatedLabel = translations[originalLabel] || originalLabel;
                  const value = chartData.datasets[datasetIndex].data[dataIndex];

                  return `${translatedLabel}: ${value}`;
                }
              }
            }
          }
        }
      };

  new Chart(ctx, config);
}
initPage();